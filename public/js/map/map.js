!function(){"use strict";var e="undefined"==typeof window?global:window;if("function"!=typeof e.require){var t={},r={},a={},n={}.hasOwnProperty,o="components/",i=function(e,t){var r=0;t&&(0===t.indexOf(o)&&(r=o.length),t.indexOf("/",r)>0&&(t=t.substring(r,t.indexOf("/",r))));var n=a[e+"/index.js"]||a[t+"/deps/"+e+"/index.js"];return n?o+n.substring(0,n.length-".js".length):e},s=/^\.\.?(\/|$)/,p=function(e,t){for(var r,a=[],n=(s.test(t)?e+"/"+t:t).split("/"),o=0,i=n.length;i>o;o++)r=n[o],".."===r?a.pop():"."!==r&&""!==r&&a.push(r);return a.join("/")},c=function(e){return e.split("/").slice(0,-1).join("/")},u=function(t){return function(r){var a=p(c(t),r);return e.require(a,t)}},l=function(e,t){var a={id:e,exports:{}};return r[e]=a,t(a.exports,u(e),a),a.exports},d=function(e,a){var o=p(e,".");if(null==a&&(a="/"),o=i(e,a),n.call(r,o))return r[o].exports;if(n.call(t,o))return l(o,t[o]);var s=p(o,"./index");if(n.call(r,s))return r[s].exports;if(n.call(t,s))return l(s,t[s]);throw new Error('Cannot find module "'+e+'" from "'+a+'"')};d.alias=function(e,t){a[t]=e},d.register=d.define=function(e,r){if("object"==typeof e)for(var a in e)n.call(e,a)&&(t[a]=e[a]);else t[e]=r},d.list=function(){var e=[];for(var r in t)n.call(t,r)&&e.push(r);return e},d.brunch=!0,d._cache=r,e.require=d}}(),require.register("map/browsesLayer",function(e,t,r){var a=t("configuration"),n=t("map/utils"),o=function(e){var t=e+"";return t.length<2&&(t="0"+t),t},i=function(e){return e.getUTCFullYear()+"-"+o(e.getUTCMonth()+1)+"-"+o(e.getUTCDate())+"T"+o(e.getUTCHours())+":"+o(e.getUTCMinutes())+":"+o(e.getUTCSeconds())+"Z"},s=function(e,r){this.params=e;var o={},s=[];this.setVisible=function(e){this.params.visible=e;for(var a=0;a<s.length;a++)s[a].params.visible=e,r.setLayerVisible(s[a].engineLayer,e);var n=t("map/map");n.trigger("visibility:changed",this)},this.clear=function(){for(var e=0;e<s.length;e++)r.removeLayer(s[e].engineLayer);o={},s=[]},this.addBrowse=function(e,t){var p=t+e.id;if(!o.hasOwnProperty(p)){o[p]=t;var c=n.createWmsLayerFromUrl(t);if(!c.params.time){var u=Date.fromISOString(a.getMappedProperty(e,"start"));u.setUTCMilliseconds(0);var l=Date.fromISOString(a.getMappedProperty(e,"stop"));l.setUTCMilliseconds(0),c.params.time=i(u)+"/"+i(l)}if("WMTS"==c.type.toUpperCase()&&!c.params.matrixSet){var d=a.get("map.projection","EPSG:4326"),h=a.get("browseDisplay.wmtsParameters",{"EPSG:4326":{params:{matrixSet:"WGS84"}},"EPSG:3857":{params:{matrixSet:"g"}}});c.projection=d,c.params.matrixSet=h[d].params.matrixSet}n.computeExtent(e),_.merge(c,{name:t,visible:this.params.visible,opacity:a.get("map.browseDisplay.opacity",1),bbox:e.bbox,crossOrigin:a.get("map.browseDisplay.crossOrigin","anonymous")}),c.params.transparent=!0;var m={time:a.getMappedProperty(e,"stop"),params:c,engineLayer:r.addLayer(c)};o[p]=m,s.push(m)}},this.removeBrowse=function(e,t){var a=t+e.id;if(o.hasOwnProperty(a)){var n=o[a];delete o[a],r.removeLayer(n.engineLayer),s.splice(s.indexOf(n),1)}},this.isEmpty=function(){return 0==s.length},this.changeEngine=function(e){r=e;for(var t=0;t<s.length;t++)s[t].engineLayer=r.addLayer(s[t].params)},this.getBrowses=function(){return s}};r.exports=s}),require.register("map/degreeConvertor",function(e,t,r){function a(e){return isNaN(e)?NaN:parseFloat(e)}var n=/^\s*(-?)(\d+)°(\d+)'(\d+)"([EWNS]{0,1})\s*$/;r.exports={toDMS:function(e,t,r){var a,r=r||{},n=0|e,o=Math.abs(e-n),i=60*o|0,s=3600*o-60*i|0,p=Math.abs(n)+(r.sep||"°")+i+(r.sep||"'")+s+(r.sep||'"');return"letter"==r.positionFlag?(a="",a=t?e>=0?"E":"W":e>=0?"N":"S",p+a):(a=e>=0?"":"-",a+p)},toDecimalDegrees:function(e){var t=n.exec(e);if(t){var r=parseFloat(t[2])+parseFloat(t[3])/60+parseFloat(t[4])/3600;return r*="W"==t[4]||"S"==t[4]||"-"==t[1]?-1:1}return Number.NaN},parseCoordinate:function(e){return n.test(e)?this.toDecimalDegrees(e):a(e)},textToDecimalDegrees:function(e){for(var t=[],r=e.trim().split("\n"),a=0;a<r.length;a++){var n=r[a].split(" "),o=this.parseCoordinate(n[0]),i=this.parseCoordinate(n[1]);t.push([i,o])}return t}}}),require.register("map/gazetteer",function(e,t,r){var a=t("configuration");r.exports={query:function(e){var t="https://nominatim.openstreetmap.org/search?";t+="q="+encodeURIComponent(e.query),t+="&format=json",a.data.gazetteer.outputPolygon&&(t+="&polygon_text=1"),t+="&limit="+a.data.gazetteer.maxResults,$.ajax({url:t,dataType:"jsonp",jsonp:"json_callback",timeout:a.data.gazetteer.timeout,success:function(t){e.result&&e.result(t)},error:function(){e.result&&e.result([])}})}}}),require.register("map/geojsonconverter",function(e,t,r){var a=t("../configuration"),n=new OpenLayers.Format.GeoJSON,o=function(e){if(e&&e.length>0){var t=n.write(e);return JSON.parse(t)}},i=function(e){var t="";t+=" <description><![CDATA[";var r=a.getFromPath(e,"properties.link[].@.rel=icon.href","");return""!==r&&(t+=' <img width="100" height="100" src="'+r+'" >'),t+=" ]]></description>"},s=function(e){var t=["identifier","title","published","updated","date","originDatasetId","productUrl","polygon"],r="";return r+=" <ExtendedData>",t.forEach(function(t){e.properties[t]&&(r+='  <Data name="'+t+'">',r+="   <value>"+e.properties[t]+"</value>",r+="  </Data>")}),r+=" </ExtendedData>"},p=function(e){var t="";return"Polygon"===e.type&&(t+=" <Polygon>",t+="  <outerBoundaryIs>",t+="   <LinearRing>",t+="    <coordinates>",e.coordinates[0].forEach(function(e){t+=e[0]+","+e[1]+" "}),t+="    </coordinates>",t+="   </LinearRing>",t+="  </outerBoundaryIs>",t+=" </Polygon>"),t},c=function(e){var t='<kml xmlns="http://earth.google.com/kml/2.0">';return t+="<Folder>",t+="<name>Export from ngEO</name>",t+="<description>Exported on "+new Date+"</description>",e.features.forEach(function(e){t+='<Placemark id="'+e.id+'">',t+=" <name>"+e.properties.title+"</name>",t+=i(e),t+=p(e.geometry),t+=s(e),t+="</Placemark>"}),t+="</Folder>",t+="</kml>"},u=function(e){var t='<metalink version="3.0" xmlns="http://www.metalinker.org/">';return t+=" <files>",e.features.forEach(function(e){var r=e.properties.productUrl,a=r.substr(r.lastIndexOf("/"),r.length);t+='  <file name="'+a+'">',t+="   <resources>",t+='    <url type="http">'+r+"</url> ",t+="   </resources>",t+="  </file>"}),t+=" </files>",t+="</metalink>"};r.exports={load:function(e,t){var r;switch(e.type){case"GeoRSS":r=new OpenLayers.Protocol.HTTP({url:e.location,format:new OpenLayers.Format.GeoRSS});break;case"WFS":r=new OpenLayers.Protocol.WFS({url:e.baseUrl,featureType:e.featureType,featureNS:e.featureNS})}r&&r.read({callback:function(e){e.features&&t(o(e.features))}})},convert:function(e,t){var r=t.toUpperCase(),a={type:"FeatureCollection",features:e};switch(r){case"KML":return c(a);case"GML":var o=n.read(a),i=new OpenLayers.Format.GML;return i.write(o);case"JSON":case"GEOJSON":return JSON.stringify(a);case"METALINK":return u(a)}},toGeoJSON:function(e){if(!e.data)return!1;var t;switch(e.type.toUpperCase()){case"KML":var r=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:0});t=r.read(e.data);break;case"GML":var a=new OpenLayers.Format.GML;t=a.read(e.data);break;case"JSON":case"GEOJSON":return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),e.type="GeoJSON",!0}return t&&t.length>0?(e.data=o(t),e.type="GeoJSON",!0):!1}}}),require.register("map/globweb",function(e,t,r){var a=t("configuration"),n=t("map/geojsonconverter"),o=365;GlobWebMapEngine=function(e){this.groundOverlays={},this.features={},this.styles={},this.parentElement=e,this.nbAddedOverlays=0;try{var t=document.createElement("canvas");t.id="map",t.width=e.clientWidth,t.height=e.clientHeight,e.appendChild(t),this.canvas=t;var r=document.createElement("div");r.id="attributions",r.className="olControlAttribution",e.appendChild(r),this.attributions=r;var n=new GlobWeb.Globe({canvas:t,tileErrorTreshold:a.get("map.globweb.tileErrorTreshold",2),continuousRendering:a.get("map.globweb.continuousRendering",!1)});new GlobWeb.AttributionHandler(n,{element:"attributions"});var o=a.get("map.globweb.elevationLayer");if(o){var i=new GlobWeb.WCSElevationLayer(o);n.setBaseElevation(i)}a.get("map.globweb.displayStats",!1)&&(this.stats=document.createElement("div"),this.stats.id="stats",e.appendChild(this.stats),new GlobWeb.Stats(n,{element:this.stats,verbose:!0})),this.$loading=$('<img src="../css/images/ajax-loader.gif" id="loading"></img>').appendTo(e),n.subscribe("baseLayersReady",function(){$("#loading").hide()});var s=new GlobWeb.Navigation(n,{mouse:{zoomOnDblClick:!1,rotateButton:2},zoomDuration:a.get("map.globweb.zoomDuration",500)});this.globe=n,this.navigation=s}catch(p){throw e.removeChild(t),e.removeChild(r),this.canvas=null,this.attributions=null,console.log("WebGL cannot be initialized."),"WebGLNotFound"}};var i=function(e){var t=new GlobWeb.FeatureStyle(e);return e.strokeColor&&(t.strokeColor=GlobWeb.FeatureStyle.fromStringToColor(e.strokeColor)),t};GlobWebMapEngine.prototype.createConditionalStyles=function(e,t){var r=["default","select","highlight","highlight-select"];_.each(r,function(r){if(t[r]){var n=i(t[r]);n.isApplicable=function(e,n){return n==r&&a.getFromPath(e,t.attribute)==t.value},e[t.attribute+"-"+t.value+"-"+r]=n}})},GlobWebMapEngine.prototype.addStyle=function(e,t){var r={};if(t["default"]||"lut"==e)for(var a in t)if("conditionals"==a)for(var n=0;n<t[a].length;n++)this.createConditionalStyles(r,t[a][n]);else t.hasOwnProperty(a)&&(r[a]=i(t[a]));else r["default"]=i(t);this.styles[e]=r},GlobWebMapEngine.prototype.setBackgroundLayer=function(e){var t;switch(e.type.toUpperCase()){case"OSM":t=new GlobWeb.OSMLayer(e);break;case"WMS":t=new GlobWeb.WMSLayer($.extend({name:e.name,baseUrl:e.baseUrl,projection:e.projection,crossOrigin:e.crossOrigin,attribution:e.attribution},e.params));break;case"WMTS":t=new GlobWeb.WMTSLayer($.extend({name:e.name,baseUrl:e.baseUrl,projection:e.projection,crossOrigin:e.crossOrigin,attribution:e.attribution,layer:e.params.layer,matrixSet:e.params.matrixSet,startLevel:"EPSG:4326"==e.projection?1:0},e.params));break;case"BING":t=new GlobWeb.BingLayer(e)}return t&&this.globe.setBaseImagery(t),this.$loading.show(),t},GlobWebMapEngine.prototype.setLayerVisible=function(e,t){e.visible(t)},GlobWebMapEngine.prototype.setLayerIndex=function(e,t){e.zIndex=t;for(var r in e.styleMap)e.styleMap[r].zIndex=t},GlobWebMapEngine.prototype.addLayer=function(e){var t;switch(e.type.toUpperCase()){case"WMS":t=new GlobWeb.WMSLayer($.extend({name:e.name,baseUrl:e.baseUrl,projection:e.projection,crossOrigin:e.crossOrigin},e.params));break;case"WMTS":var r={name:e.name,baseUrl:e.baseUrl,style:e.params.style,layer:e.params.layer,projection:e.projection,format:e.params.format,matrixSet:e.params.matrixSet,startLevel:"EPSG:4326"==e.projection?1:0,time:e.params.time,crossOrigin:e.crossOrigin};e.bbox&&(r.geoBound=new GlobWeb.GeoBound(e.bbox[0],e.bbox[1],e.bbox[2],e.bbox[3])),t=new GlobWeb.WMTSLayer(r);break;case"FEATURE":case"JSON":case"GEOJSON":t=new GlobWeb.VectorLayer({name:e.name,visible:e.visible}),e.data&&("string"==typeof e.data?this.addFeature(t,JSON.parse(e.data)):this.addFeature(t,e.data));break;case"WFS":case"GEORSS":t=new GlobWeb.VectorLayer({name:e.name,visible:e.visible,attribution:e.attribution,style:new GlobWeb.FeatureStyle({iconUrl:"../images/point.png",pointMaxSize:4e4})}),n.load(e,$.proxy(t.addFeatureCollection,t));break;case"KML":t=new GlobWeb.VectorLayer(e),$.get(e.location,function(e){var r=GlobWeb.KMLParser.parse(e);t.addFeatureCollection(r)})}return t&&(e.style&&this.styles.hasOwnProperty(e.style)&&(t.style=this.styles[e.style]["default"],t.styleMap=_.extend({},this.styles.lut,this.styles[e.style])),("WMS"==e.type.toUpperCase()||"WMTS"==e.type.toUpperCase())&&(t.zIndex=o+this.nbAddedOverlays,this.nbAddedOverlays++),t.visible(e.visible),this.globe.addLayer(t)),t},GlobWebMapEngine.prototype.removeLayer=function(e){this.globe.removeLayer(e),(e instanceof GlobWeb.WMTSLayer||e instanceof GlobWeb.WMSLayer)&&this.nbAddedOverlays--},GlobWebMapEngine.prototype.subscribe=function(e,t){switch(e){case"init":t(this);break;case"navigationModified":this.navigation.subscribe("modified",t);break;case"mousedown":case"mousemove":case"mouseup":case"click":case"dblclick":this.canvas.addEventListener(e,t)}},GlobWebMapEngine.prototype.unsubscribe=function(e,t){switch(e){case"startNavigation":this.globe.unsubscribe("startNavigation",t);break;case"endNavigation":this.globe.unsubscribe("endNavigation",t);break;case"mousedown":case"mousemove":case"mouseup":case"click":case"dblclick":this.canvas.removeEventListener(e,t)}},GlobWebMapEngine.prototype.updateSize=function(){this.canvas.width=this.parentElement.clientWidth,this.canvas.height=this.parentElement.clientHeight,this.globe.refresh()},GlobWebMapEngine.prototype.getLonLatFromPixel=function(e,t){var r=this.globe.getLonLatFromPixel(e,t);return r&&(r.length=2),r},GlobWebMapEngine.prototype.getPixelFromLonLat=function(e,t){var r=this.globe.getPixelFromLonLat(e,t);return{x:r[0],y:r[1]}},GlobWebMapEngine.prototype.getViewportExtent=function(){var e=this.globe.getViewportGeoBound();return e?[e.getWest(),e.getSouth(),e.getEast(),e.getNorth()]:[-180,-90,180,90]},GlobWebMapEngine.prototype.zoomIn=function(){this.navigation.zoom(-2),this.globe.refresh()},GlobWebMapEngine.prototype.zoomOut=function(){this.navigation.zoom(2),this.globe.refresh()},GlobWebMapEngine.prototype.zoomToExtent=function(e){var t=.5*(e[0]+e[2]),r=.5*(e[1]+e[3]),n=e[0]*Math.PI/180,o=e[2]*Math.PI/180,i=r*Math.PI/180,s=6371e3,p=(o-n)*Math.cos(i),c=p*s;c/=Math.cos(22.5*Math.PI/180),c=Math.min(c,2*s);var u=[t,r];this.navigation.zoomTo(u,c,a.get("map.globweb.zoomDuration",500))},GlobWebMapEngine.prototype.removeAllFeatures=function(e){e.removeAllFeatures()},GlobWebMapEngine.prototype.addFeature=function(e,t){var r="FeatureCollection"==t.type;r?e.addFeatureCollection(t):e.addFeature(t)},GlobWebMapEngine.prototype.modifyFeatureStyle=function(e,t,r){e.modifyFeatureStyle(t,e.styleMap[r]),this.globe.refresh()},GlobWebMapEngine.prototype.blockNavigation=function(e){e?this.navigation.stop():this.navigation.start()},GlobWebMapEngine.prototype.updateFeature=function(e,t){e.removeFeature(t),e.addFeature(t)},GlobWebMapEngine.prototype.removeFeature=function(e,t){e.removeFeature(t)},GlobWebMapEngine.prototype.applyConditionalStyling=function(e,t,r){var a=r,n=e.styleMap;for(var o in n){var i=n[o];i.isApplicable&&i.isApplicable(t,r)&&(a=o)}return a},GlobWebMapEngine.prototype.destroy=function(){this.globe.dispose(),this.parentElement.removeChild(this.canvas),this.parentElement.removeChild(this.attributions),this.stats&&this.parentElement.removeChild(this.stats),this.$loading.remove(),this.globe=null,this.parentElement=null,this.canvas=null,this.attributions=null,this.navigation=null},r.exports=GlobWebMapEngine}),require.register("map/handler",function(e,t,r){var a=t("map/map"),n=function(e){var t=null;this.start=function(r){t=a.handler,t&&t.stop(),a.handler=this,e.start(r)},this.stop=function(){e.stop(),a.handler=null,t&&(t.start(),t=null)};for(var r in e)e[r]instanceof Function&&"start"!=r&&"stop"!=r&&(this[r]=e[r])};r.exports=n}),require.register("map/layerImport",function(e,t,r){var a=t("map/map"),n=function(e){return e.preventDefault&&e.preventDefault(),!1},o=function(e,t){e.stopPropagation(),e.preventDefault();for(var r=e.dataTransfer.files,n=0;n<r.length;n++){var o=new FileReader,i=r[n],s=i.name.substr(i.name.indexOf(".")+1);o.onloadend=function(e){if(e.target.readyState==FileReader.DONE){var r={name:"Imported File : "+i.name,type:s,visible:!0,style:"imported",data:e.target.result};t?t(r,i):a.addLayer(r)}},o.readAsText(i)}};r.exports={addDropArea:function(e,t){e.addEventListener("dragover",n),e.addEventListener("dragenter",n),e.addEventListener("drop",function(e){o(e,t)})},isSupported:function(){return void 0!=window.FileReader}}}),require.register("map/map",function(e,t,r){var a=t("configuration"),n=t("map/openlayers"),o=t("map/globweb"),i=t("userPrefs"),s=t("map/browsesLayer"),p=t("map/utils"),c=t("map/degreeConvertor"),u=function(e,t){this.params=e,this.engineLayer=t,this.setVisible=function(e){if(this.params.visible=e,"Feature"!=this.params.type){var t=JSON.parse(i.get("Visible layers")||"[]");if(e)t.push(this.params.name);else{var r=t.indexOf(this.params.name);-1!=r&&t.splice(r,1)}i.save("Visible layers",JSON.stringify(t))}g.setLayerVisible(this.engineLayer,e),h.trigger("visibility:changed",this)},this.changeEngine=function(e){this.engineLayer=e.addLayer(this.params)}},l=function(e,t){var r=e.greatCircle&&!t._origGeometry;r&&(t._origGeometry={coordinates:$.extend(!0,[],t.geometry.coordinates),type:t.geometry.type},p.tesselateGreatCircle(t))},d=function(e,t){u.prototype.constructor.call(this,e,t),this.features=[],this.clear=function(){this.features=[],g.removeAllFeatures(this.engineLayer)},this.addFeatures=function(e){for(var t=0;t<e.length;t++)this.addFeature(e[t])},this.addFeature=function(t){t.geometry&&(l(e,t),g.addFeature(this.engineLayer,t),this.modifyFeaturesStyle([t],"default"),this.features.push(t))},this.removeFeatures=function(e){for(var t=0;t<e.length;t++)g.removeFeature(this.engineLayer,e[t]),this.features.splice(this.features.indexOf(e[t]),1)},this.modifyFeaturesStyle=function(e,t){for(var r=0;r<e.length;r++){var a=e[r],n=_.find(this.features,function(e){return e.id===a.id});n&&(n.renderHint=t,t=g.applyConditionalStyling(this.engineLayer,n,t),g.modifyFeatureStyle(this.engineLayer,n,t))}},this.updateFeature=function(t,r){l(e,t),g.updateFeature(this.engineLayer,t,r)},this.changeEngine=function(e){this.engineLayer=e.addLayer(this.params);for(var t=0;t<this.features.length;t++){var r=this.features[t];r.geometry=_.omit(r.geometry,"_bucket","_tileIndices"),e.addFeature(this.engineLayer,r),r.renderHint&&e.modifyFeatureStyle(this.engineLayer,r,r.renderHint)}}},h=null,m={"2d":n,"3d":o},g=null,f=null,y=null,v=[-180,-85,180,85],b=!1,L=function(e){if("Browses"==e.type)return new s(e,g);if("Feature"==e.type)return new d(e,g.addLayer(e));var t=g.addLayer(e);return t?new u(e,t):void 0},M=function(e){var t=h.getLonLatFromEvent(e);if(t){var r=c.toDMS(t[0],!0),a=c.toDMS(t[1],!1);r=r.replace(/\b(\d{1})\b/g,"0$1"),a=a.replace(/\b(\d{1})\b/g,"0$1"),$("#coordinatesViewer").html(a+" "+r)}},w=function(e){g.setBackgroundLayer(y);for(var t in e.styles)e.styles.hasOwnProperty(t)&&g.addStyle(t,e.styles[t]);for(var r=0;r<h.layers.length;r++)h.layers[r].changeEngine(g);g.zoomToExtent(v),g.subscribe("navigationModified",function(){h.trigger("extent:change",h)}),g.subscribe("mousemove",M)},x=function(e){switch(e.type){case"Bing":case"OSM":return!b;case"WMTS":return a.data.map.projection==e.projection;case"WMS":return e.projection?a.data.map.projection==e.projection:!0;case"GeoJSON":case"KML":case"GeoRSS":case"WFS":return!0;default:return!1}};r.exports={handler:null,backgroundLayers:[],layers:[],initialize:function(e){h=this,_.extend(h,Backbone.Events),f=document.getElementById(e);var t=i.get("Map mode")?i.get("Map mode"):"2d";g=new m[t](f),b="EPSG:4326"==a.data.map.projection;for(var r=a.data.map.backgroundLayers,n=0;n<r.length;n++)x(r[n])&&h.backgroundLayers.push(r[n]);for(var o=JSON.parse(i.get("Visible layers")||"[]"),s=a.data.map.layers,n=0;n<s.length;n++){var p=s[n];x(p)&&(-1!=o.indexOf(p.name)&&(p.visible=!0),h.layers.push(new u(p,null)))}var c=i.get("Background");y=_.findWhere(h.backgroundLayers,{id:c}),y||(y=h.backgroundLayers[0]),w(a.data.map)},setBackgroundLayer:function(e){y=e;var t=g.setBackgroundLayer(e);return i.save("Background",e.id),this.trigger("backgroundLayerSelected",e),t},getBackgroundLayer:function(){return y},addLayer:function(e){var t;return e.isBackground?(e.visible&&(t=this.setBackgroundLayer(e)),h.backgroundLayers.push(e),h.trigger("backgroundLayerAdded",e)):(t=L(e),h.layers.push(t),h.trigger("layerAdded",t)),t},removeLayer:function(e){if(e.params.isBackground){var t=h.backgroundLayers.indexOf(e.params),e=h.backgroundLayers[t];return t>=0&&(h.backgroundLayers.splice(t,1),y==e.params&&h.setBackgroundLayer(h.backgroundLayers[0]),h.trigger("backgroundLayerRemoved",e)),!0}var t=h.layers.indexOf(e);if(t>=0){var e=h.layers[t];e.clear&&e.clear(),e.engineLayer&&g.removeLayer(e.engineLayer);var t=h.layers.indexOf(e);return h.layers.splice(t,1),h.trigger("layerRemoved",e),!0}return!1},zoomIn:function(){g.zoomIn()},zoomOut:function(){g.zoomOut()},zoomToMaxExtent:function(){g.zoomToExtent(v)},zoomToFeature:function(e){e.bbox||p.computeExtent(e);var t=e.bbox,r=t[2]-t[0],a=t[3]-t[1],n=[t[0]-2*r,t[1]-2*a,t[2]+2*r,t[3]+2*a];g.zoomToExtent(n)},zoomTo:function(e){g.zoomToExtent(e)},getViewportExtent:function(){var e=g.getViewportExtent();return e[0]=p.normalizeLon(e[0]),e[1]=Math.max(-90,e[1]),e[2]=p.normalizeLon(e[2]),e[3]=Math.min(90,e[3]),e},getPixelFromLonLat:function(e,t){return g.getPixelFromLonLat(e,t)},getLonLatFromPixel:function(e,t){return g.getLonLatFromPixel(e,t)},getLonLatFromEvent:function(e){var t=f.getBoundingClientRect(),r=e.pageX-t.left,a=e.pageY-t.top;return g.getLonLatFromPixel(r,a)},switchMapEngine:function(e){if(!m[e])return!1;var t=null;if(g){this.handler&&(t=this.handler,this.handler.stop()),g.unsubscribe("mousemove",M);var r=g.getViewportExtent();g.destroy(),g=null}var n=function(e){w(a.data.map),r&&e.zoomToExtent(r),t&&t.start()};try{g=new m[e](f)}catch(o){g=null}return i.save("Map mode",e),g&&g.subscribe("init",n),null!=g},updateViewportSize:function(){g&&g.updateSize()},getMapEngine:function(){return g}}}),require.register("map/openlayers",function(e,t,r){var a=t("configuration"),n=t("map/utils"),o=a.get("map.projection","EPSG:4326"),i=function(){if("EPSG:4326"==o){for(var e=[.703125],t=0;15>t;t++)e.push(.5*e[e.length-1]);return e}return null},s=function(e){e.serverResolutions=i(),"EPSG:4326"==o?(e.tileFullExtent=new OpenLayers.Bounds(-180,-90,180,90),e.tileOrigin=new OpenLayers.LonLat(-180,90)):"EPSG:3857"==o&&(e.tileFullExtent=new OpenLayers.Bounds(-20037508.34278925,-20037508.34278925,20037508.34278925,20037508.34278925),e.tileOrigin=new OpenLayers.LonLat(-20037508.34278925,20037508.34278925))};OpenLayersMapEngine=function(e){this.element=e;var t=a.get("map.openlayers.restrictedExtent",[-180,-90,180,90]),r=new OpenLayers.Projection(a.get("map.projection","EPSG:4326")),n=new OpenLayers.Projection("EPSG:4326"),o=new OpenLayers.Bounds(t);o.transform(n,r);var i=this.computeResolutions(o);this._map=new OpenLayers.Map(this.element,{controls:[new OpenLayers.Control.Navigation({zoomWheelEnabled:!0,defaultDblClick:function(e){}}),new OpenLayers.Control.Attribution],projection:r,displayProjection:n,restrictedExtent:o,theme:null,autoUpdateSize:!1,resolutions:i,fallThrough:!0}),this._geoJsonFormat=new OpenLayers.Format.GeoJSON({externalProjection:this._map.displayProjection,internalProjection:this._map.projection}),this.styles={}},OpenLayersMapEngine.prototype.computeResolutions=function(e){var t=i();if(t)for(var r=(e.right-e.left)/this.element.offsetWidth,a=(e.top-e.bottom)/this.element.offsetHeight,n=Math.min(r,a);t[0]>n;)t.shift();return t},OpenLayersMapEngine.prototype.createConditionalStyles=function(e,t){var r=["default","select","highlight","highlight-select"];_.each(r,function(r){if(t[r]){var n=new OpenLayers.Style(t[r]);n.isApplicable=function(e,n){return n==r&&a.getFromPath(e,t.attribute)==t.value},e.styles[t.attribute+"-"+t.value+"-"+r]=n}})},OpenLayersMapEngine.prototype.addStyle=function(e,t){if(this.styles[e]=new OpenLayers.StyleMap(t),t.conditionals)for(var r=this,a=0;a<t.conditionals.length;a++)r.createConditionalStyles(r.styles[e],t.conditionals[a])},OpenLayersMapEngine.prototype.setBackgroundLayer=function(e){var t;switch(e.type.toUpperCase()){case"OSM":t=new OpenLayers.Layer.OSM(e.name,e.baseUrl+"/${z}/${x}/${y}.png");break;case"WMS":t=new OpenLayers.Layer.WMS(e.name,e.baseUrl,e.params);break;case"BING":t=new OpenLayers.Layer.Bing({name:e.name,key:e.key,type:e.imageSet});break;case"WMTS":var r={name:e.name,url:e.baseUrl,layer:e.params.layer,matrixSet:e.params.matrixSet,matrixIds:e.params.matrixIds,format:e.params.format,style:e.params.style,isBaseLayer:!0,projection:e.projection};s(r),e.bbox&&(r.maxExtent=new OpenLayers.Bounds(e.bbox)),t=new OpenLayers.Layer.WMTS(r)}return t&&(t.attribution=e.attribution,t.wrapDateLine=!0,t.transitionEffect=a.get("map.openlayers.transitionEffect",null),this._map.addLayer(t),this._map.setBaseLayer(t),t.updateMatrixProperties&&t.updateMatrixProperties()),t},OpenLayersMapEngine.prototype.setLayerVisible=function(e,t){e.setVisibility(t)},OpenLayersMapEngine.prototype.setLayerIndex=function(e,t){this._map.setLayerIndex(e,t)},OpenLayersMapEngine.prototype.addLayer=function(e){var t;switch(e.type.toUpperCase()){case"WMS":var r;e.bbox&&(r=new OpenLayers.Bounds(e.bbox[0],e.bbox[1],e.bbox[2],e.bbox[3]),r.transform(this._map.displayProjection,this._map.projection)),t=new OpenLayers.Layer.WMS(e.name,e.baseUrl,e.params,{maxExtent:r,isBaseLayer:!1,opacity:e.hasOwnProperty("opacity")?e.opacity:1});break;case"WMTS":var n={name:e.name,url:e.baseUrl,layer:e.params.layer,matrixSet:e.params.matrixSet,matrixIds:e.params.matrixIds,format:e.params.format,style:e.params.style,isBaseLayer:!1,projection:e.projection,opacity:e.hasOwnProperty("opacity")?e.opacity:1,transitionEffect:a.get("map.openlayers.transitionEffect",null)};s(n),e.params.time&&(n.dimensions=["TIME"],n.params={TIME:e.params.time}),e.bbox&&(n.maxExtent=new OpenLayers.Bounds(e.bbox).transform(this._map.displayProjection,this._map.projection)),t=new OpenLayers.Layer.WMTS(n);break;case"GEORSS":t=new OpenLayers.Layer.Vector(e.name,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:e.location,format:new OpenLayers.Format.GeoRSS}),projection:"EPSG:4326"});break;case"WFS":t=new OpenLayers.Layer.Vector(e.name,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.WFS({url:e.baseUrl,featureType:e.featureType,featureNS:e.featureNS}),projection:"EPSG:4326"});break;case"KML":if(e.data){var o=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:0}),i=o.read(e.data);t=new OpenLayers.Layer.Vector(e.name,{projection:"EPSG:4326"}),t.addFeatures(i)}else e.location&&(t=new OpenLayers.Layer.Vector(e.name,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:e.location,format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:0})}),projection:"EPSG:4326"}));break;case"FEATURE":case"JSON":case"GEOJSON":if(t=new OpenLayers.Layer.Vector(e.name,{renderers:["Canvas","VML"],projection:"EPSG:4326"}),e.data){var p=new OpenLayers.Format.GeoJSON,i=p.read(e.data);t.addFeatures(i)}}return t&&(t.attribution=e.attribution,e.style&&this.styles[e.style]&&(t.styleMap=this.styles[e.style]),t.setVisibility(e.visible),this._map.addLayer(t)),t},OpenLayersMapEngine.prototype.removeLayer=function(e){e.destroy()},OpenLayersMapEngine.prototype.subscribe=function(e,t){switch(e){case"init":t(this);break;case"navigationModified":this._map.events.register("move",void 0,t);break;case"mousedown":case"mouseup":case"mousemove":case"click":case"dblclick":this._map.events.register(e,void 0,t,!0)}},OpenLayersMapEngine.prototype.unsubscribe=function(e,t){switch(e){case"navigationModified":this._map.events.unregister("move",void 0,t);break;case"mousedown":case"mouseup":case"mousemove":case"click":case"dblclick":this._map.events.unregister(e,void 0,t,!0)}},OpenLayersMapEngine.prototype.updateSize=function(){this._map.resolutions=this.computeResolutions(this._map.restrictedExtent),this._map.baseLayer.initResolutions(),this._map.updateSize()},OpenLayersMapEngine.prototype.getLonLatFromPixel=function(e,t){var r=this._map.getLonLatFromPixel(new OpenLayers.Pixel(e,t));return r=r.transform(this._map.projection,this._map.displayProjection),[r.lon,r.lat]},OpenLayersMapEngine.prototype.getPixelFromLonLat=function(e,t){var r=new OpenLayers.LonLat(e,t);r=r.transform(this._map.displayProjection,this._map.projection);var a=this._map.getPixelFromLonLat(r);return{x:a.x,y:a.y}},OpenLayersMapEngine.prototype.getViewportExtent=function(){var e=this._map.getExtent();if(e){var t=[],r=e.transform(this._map.projection,this._map.displayProjection),a=Math.abs(r.getWidth()),n=Math.abs(r.getHeight());return t[0]=r.getCenterLonLat().lon-.5*a,t[1]=r.getCenterLonLat().lat-.5*n,t[2]=r.getCenterLonLat().lon+.5*a,t[3]=r.getCenterLonLat().lat+.5*n,t}return null},OpenLayersMapEngine.prototype.zoomToExtent=function(e){var t=new OpenLayers.Bounds(e[0],e[1],e[2],e[3]);t.transform(this._map.displayProjection,this._map.projection);var r=t.getCenterLonLat();this._map.setCenter(r,this._map.getZoomForExtent(t,!0))},OpenLayersMapEngine.prototype.zoomIn=function(){this._map.zoomIn()},OpenLayersMapEngine.prototype.zoomOut=function(){this._map.zoomOut()},OpenLayersMapEngine.prototype.removeAllFeatures=function(e){e.removeAllFeatures()},OpenLayersMapEngine.prototype.addFeature=function(e,t){var r=this._geoJsonFormat.read(n.fixDateLine(t));e.addFeatures(r),e.drawFeature(e.getFeatureByFid(t.id),t.renderHint)},OpenLayersMapEngine.prototype.modifyFeatureStyle=function(e,t,r){var a=e.getFeatureByFid(t.id);a&&(a.renderIntent=r,e.drawFeature(a,r))},OpenLayersMapEngine.prototype.applyConditionalStyling=function(e,t,r){var a=r,n=e.styleMap.styles;for(var o in n){var i=n[o];i.isApplicable&&i.isApplicable(t,r)&&(a=o)}return a},OpenLayersMapEngine.prototype.blockNavigation=function(e){e?this._map.controls[0].deactivate():this._map.controls[0].activate()},OpenLayersMapEngine.prototype.updateFeature=function(e,t,r){t=r?r(t):n.fixDateLine(t);var a=e.getFeatureByFid(t.id);e.removeFeatures(a),e.addFeatures(this._geoJsonFormat.read(t))},OpenLayersMapEngine.prototype.removeFeature=function(e,t){var r=e.getFeatureByFid(t.id);e.removeFeatures(r)},OpenLayersMapEngine.prototype.destroy=function(){this._map.destroy(),this.element.className=""},r.exports=OpenLayersMapEngine}),require.register("map/polygonHandler",function(e,t,r){function a(){l.splice(l.length-2,1),b.stop()}function n(e){var t=Date.now(),r=250>t-g&&Math.abs(e.pageX-f)<1&&Math.abs(e.pageY-y)<1;return g=t,f=e.pageX,y=e.pageY,r}function o(){c.geometry.type="Polygon",c.geometry.coordinates=[l],c.bbox=null,p.updateFeature(c)}function i(e){if(m&&0==e.button)if(n(e))m=!1,setTimeout(a,50);else{var t=h.getLonLatFromEvent(e);0==l.length?l.push(t,t,t):(l[l.length-2]=t,l.splice(l.length-1,0,t)),o()}}function s(e){if(m&&l.length>0&&0==e.button){var t=h.getLonLatFromEvent(e);l[l.length-2]=t,o()}}var p,c,u,l,d=t("map/handler"),h=t("map/map"),m=!1,g=-1,f=-1,y=-1,v=null,b=null;b=new d({start:function(e){if(u=h.getMapEngine(),e.layer)p=e.layer,c=e.feature,l=c.geometry.coordinates[0];else if(!p){l=[],c={id:"0",type:"Feature",geometry:{type:"Polygon",coordinates:[l]}};var t={name:"Draw Area",type:"Feature",visible:!0,style:"imported",data:c};p=h.addLayer(t)}u.blockNavigation(!0),u.subscribe("mousemove",s),u.subscribe("mouseup",i),v=e.stop,l.length=0,m=!0},stop:function(){u.blockNavigation(!1),u.unsubscribe("mousemove",s),u.unsubscribe("mouseup",i),v&&(c.geometry.type="Polygon",c.geometry.coordinates=[l],v())}}),r.exports=b}),require.register("map/rectangle",function(e,t,r){var a=t("map/utils"),n=function(e){if(e.feature){this.feature=e.feature;var t=a.computeBbox(this.feature.geometry);this.west=t[0],this.south=t[1],this.east=t[2],this.north=t[3],this.computeStep(),this.updateFeature({type:this.feature.geometry.type})}else this.west=e.west,this.south=e.south,this.east=e.east,this.north=e.north,this.feature={id:"Dynamic rectangle",type:"Feature",geometry:{},properties:{}},this.updateFeature({type:e.type})};n.prototype.computeStep=function(){var e=4;this.step=this.west>this.east?(180-this.west+180+this.east)/e:(this.east-this.west)/e},n.prototype.updateFeature=function(e){var t=this.west>this.east?"MultiLineString":"Polygon";e&&e.type&&(t=e.type),this.computeStep(),this.feature.geometry.type=t,"MultiLineString"==t?this.feature.geometry.coordinates=[[[-180,this.north],[this.east,this.north],[this.east,this.south],[-180,this.south]],[[180,this.north],[this.west,this.north],[this.west,this.south],[180,this.south]],[[-180,this.north],[this.west-360,this.north],[this.west-360,this.south],[-180,this.south]],[[180,this.north],[this.east+360,this.north],[this.east+360,this.south],[180,this.south]]]:this.feature.geometry.coordinates=[[[this.west,this.south],[a.normalizeLon(this.west+this.step),this.south],[a.normalizeLon(this.west+2*this.step),this.south],[a.normalizeLon(this.west+3*this.step),this.south],[this.east,this.south],[this.east,this.north],[a.normalizeLon(this.west+3*this.step),this.north],[a.normalizeLon(this.west+2*this.step),this.north],[a.normalizeLon(this.west+this.step),this.north],[this.west,this.north],[this.west,this.south]]];
},r.exports=n}),require.register("map/rectangleHandler",function(e,t,r){function a(e,t){if(e&&t){M(e,t)?(minX=e[0],maxX=t[0]):(minX=t[0],maxX=e[0]);var r=Math.min(e[1],t[1]),a=Math.max(e[1],t[1]);p.feature.bbox=[minX,r,maxX,a],p.west=minX,p.east=maxX,p.north=a,p.south=r,p.updateFeature();var n=function(e){return e};s.updateFeature(p.feature,"MultiLineString"==c.geometry.type?n:null)}}function n(e){0==e.button&&(u=g.getLonLatFromEvent(e),l=g.getLonLatFromEvent(e),a(u,u),v=!0)}function o(e){v&&0==e.button&&(l=g.getLonLatFromEvent(e),a(u,l))}function i(e){v&&0==e.button&&(l=g.getLonLatFromEvent(e),a(u,l),L.stop(),v=!1)}var s,p,c,u,l,d,h,m=t("map/handler"),g=t("map/map"),f=t("map/utils"),y=t("map/rectangle"),v=!1,b=null,L=null,M=function(e,t){if(p.feature.bbox){var r={lat:t[1],lon:t[0]},a={lat:t[1],lon:e[0]},n=2007e3;if(f.distanceBetween(r,a)<n&&p.step<30){var o={lat:-1,lon:e[0]},i={lat:1,lon:e[0]},s=f.crossTrackDistanceBetween(r,o,i);h=s>0?!0:!1}}return h};L=new m({start:function(e){if(d=g.getMapEngine(),e.layer)s=e.layer,c=e.feature,p=new y({feature:c});else if(!s){coords=[],p=new y({west:0,east:1,south:0,north:1});var t={name:"Draw Area",type:"Feature",visible:!0,style:"imported",data:c};s=g.addLayer(t)}d.blockNavigation(!0),d.subscribe("mousedown",n),d.subscribe("mousemove",o),d.subscribe("mouseup",i),b=e.stop},stop:function(){d.blockNavigation(!1),d.unsubscribe("mousedown",n),d.unsubscribe("mousemove",o),d.unsubscribe("mouseup",i),b&&b()}}),r.exports=L}),require.register("map/selectHandler",function(e,t,r){function a(e){0==e.button&&(i=e.pageX,s=e.pageY,p=Date.now())}function n(){v||(m=[])}var o,i,s,p,c=t("configuration"),u=t("map/handler"),l=t("map/map"),d=t("map/utils"),h=t("searchResults/model/searchResults"),m=[],g=[],f=[],y=-1,v=!1,b=-1,L=function(e,t){var r=t.length;t[0][0]==t[r-1][0]&&t[0][1]==t[r-1][1]&&r--;for(var a=!1,n=r-1,o=0;r>o;n=o++)t[o][1]>e[1]!=t[n][1]>e[1]&&e[0]<(t[n][0]-t[o][0])*(e[1]-t[o][1])/(t[n][1]-t[o][1])+t[o][0]&&(a=!a);return a},M=function(e,t,r,a){var n=t[0]-e[0],o=t[1]-e[1],i=e[0]-r[0],s=e[1]-r[1],p=n*n+o*o,c=2*(i*n+s*o),u=i*i+s*s-a*a,l=c*c-4*p*u;if(0>=l)return!1;l=Math.sqrt(l);var d=(-c-l)/(2*p),h=(-c+l)/(2*p);return d>=0&&1>=d||h>=0&&1>=h},w=function(e,t){if(0>b){var r=l.getPixelFromLonLat(e[0],e[1]),a=l.getLonLatFromPixel(r.x+1,r.y+1);b=1.5*Math.sqrt((a[0]-e[0])*(a[0]-e[0])+(a[1]-e[1])*(a[1]-e[1]))}for(var n=0;n<t.length-1;n++)if(M(t[n],t[n+1],e,b))return!0;return!1},x=function(e,t){switch(t.type){case"MultiPolygon":for(var r=!1,a=0;a<t.coordinates.length&&!r;a++)r=L(e,t.coordinates[a][0]);return r;case"Polygon":return L(e,t.coordinates[0]);case"LineString":return w(e,t.coordinates);case"MultiLineString":for(var r=!1,a=0;a<t.coordinates.length&&!r;a++)r=w(e,t.coordinates[a]);return r;default:return!1}},E=function(e){b=-1;for(var t=[],r=0;r<f.length;r++){var a=f[r];if(!(g.indexOf(a._footprintLayer)>=0))for(var n=0;n<a.features.length;n++){var o=d.fixDateLine(a.features[n]);x(e,o.geometry)&&(o._featureCollection=a,t.push(o))}}return t},S=function(e){if(m.length==e.length){for(var t=0;t<m.length;t++)if(m[t].id!=e[t].id)return!1;return!0}return!1},O=function(e,t){return new Date(c.getMappedProperty(t,"start"))-new Date(c.getMappedProperty(e,"start"))},F=function(e){if(0==e.button&&0!=f.length){var t=Math.abs(e.pageX-i),r=Math.abs(e.pageY-s),a=Date.now()-p;if(!(t>1||r>1||a>500)){var n=l.getLonLatFromEvent(e);if(n){var o=E(n);o.sort(O),v=!0,S(o)?(y++,y==m.length?(y=-1,l.trigger("pickedFeatures",m,f)):l.trigger("pickedFeatures",[m[y]],f)):(m=o,y=-1,l.trigger("pickedFeatures",m,f)),v=!1}}}};r.exports=new u({initialize:function(e){},addFeatureCollection:function(e){f.push(e)},removeFeatureCollection:function(e){this.setPickable(e._footprintLayer,!0);var t=f.indexOf(e);t>=0&&f.splice(t,1)},setPickable:function(e,t){if(t){var r=g.indexOf(e);r>=0&&g.splice(r,1)}else g.push(e)},start:function(){o=l.getMapEngine(),o.subscribe("mousedown",a),o.subscribe("mouseup",F),h.on("selectFeatures",n),h.on("unselectFeatures",n)},stop:function(){o.unsubscribe("mousedown",a),o.unsubscribe("mouseup",F)}})}),require.register("map/utils",function(e,t,r){var a=t("map/vector3d"),n=function(e){return e*Math.PI/180};r.exports={earthRadius:6371e3,normalizeLon:function(e){for(;e>180;)e-=360;for(;-180>e;)e+=360;return e},computeBbox:function(e){var t=[];switch(e.type){case"Point":var r=e.coordinates;return[r[0],r[1],r[0],r[1]];case"MultiPoint":t.push(e.coordinates);break;case"Polygon":t.push(e.coordinates[0]);break;case"MultiPolygon":for(var a=e.coordinates.length,n=0;a>n;n++)t.push(e.coordinates[n][0]);break;case"LineString":t.push(e.coordinates);break;case"MultiLineString":for(var a=e.coordinates.length,n=0;a>n;n++)t.push(e.coordinates[n])}if(0!=t.length){for(var o=1e4,i=1e4,s=-1e4,p=-1e4,n=0;n<t.length;n++)for(var c=t[n],u=0;u<c.length;u++)o=Math.min(o,c[u][0]),i=Math.min(i,c[u][1]),s=Math.max(s,c[u][0]),p=Math.max(p,c[u][1]);return[o,i,s,p]}},computeExtent:function(e){e.bbox||(e.bbox=this.computeBbox(e.geometry))},tesselateGreatCircle:function(e){var t=e.geometry;switch(t.type){case"Polygon":t.coordinates[0]=this.tesselateGreatCircleCoordinates(t.coordinates[0]);break;case"MultiPolygon":for(var r=0;r<t.coordinates.length;r++)t.coordinates[r][0]=this.tesselateGreatCircleCoordinates(t.coordinates[r][0]);break;case"LineString":t.coordinates=this.tesselateGreatCircleCoordinates(t.coordinates);break;case"MultiLineString":for(var r=0;r<t.coordinates.length;r++)t.coordinates[r]=this.tesselateGreatCircleCoordinates(t.coordinates[r])}},crossDateLine:function(e){for(var t=0;t<e.length-1;t++){var r=e[t][0],a=e[t+1][0];if(Math.abs(r-a)>180)return!0}return!1},fixDateLine:function(e){var t=!1,r=e.geometry;switch(r.type){case"Polygon":t=this.crossDateLine(r.coordinates[0]);break;case"MultiPolygon":for(var a=[],n=0;n<r.coordinates.length;n++)t|=this.crossDateLine(r.coordinates[n][0]),a=a.concat(r.coordinates[n][0]);t|=this.crossDateLine(a);break;case"LineString":t=this.crossDateLine(r.coordinates);break;case"MultiLineString":for(var n=0;n<r.coordinates.length;n++)t|=this.crossDateLine(r.coordinates[n])}return t?this.splitFeature(e):e},splitFeature:function(e){var t=e.geometry,r={id:e.id,type:"Feature",geometry:{},properties:e.properties};switch(t.type){case"Polygon":var a=this.fixDateLineCoords(t.coordinates[0]);r.geometry.type="MultiPolygon",r.geometry.coordinates=[[a[0]],[a[1]],[a[2]]];break;case"MultiPolygon":for(var n=[],o=0;o<t.coordinates.length;o++){var a=this.fixDateLineCoords(t.coordinates[o][0]);n.push([a[0]],[a[1]],[a[2]])}r.geometry.type="MultiPolygon",r.geometry.coordinates=n;break;case"LineString":r.geometry.type="MultiLineString",r.geometry.coordinates=this.fixDateLineCoords(t.coordinates);break;case"MultiLineString":for(var n=[],o=0;o<t.coordinates.length;o++){var a=this.fixDateLineCoords(t.coordinates[o]);n.push(a[0],a[1],a[2])}r.geometry.type="MultiLineString",r.geometry.coordinates=n}return t._bucket&&(r.geometry._bucket=t._bucket),r},fixDateLineCoordsWithSplit:function(e){var t=0,r=0,a=[],n=[],o=[];o=a;for(var i=0;i<e.length;i++){var s=[e[i][0],e[i][1]],p=i+1;p==e.length&&(p=0);var c=[e[p][0],e[p][1]];if(s[0]-c[0]>180){o.push(s);var u,l=c[0]+360-s[0],d=c[1]-s[1];u=0!==l?[180,s[1]+(180-s[0])*d/l]:[180,s[1]],o.push(u);var h;h=0!==l?[-180,s[1]+(180-s[0])*d/l]:[-180,s[1]],o=o===a?n:a,o.push(h)}else if(s[0]-c[0]<-180){o.push(s);var u,l=c[0]-360-s[0],d=c[1]-s[1];u=0!==l?[-180,s[1]+(-180-s[0])*d/l]:[-180,s[1]],o.push(u);var h;h=0!==l?[180,s[1]+(-180-s[0])*d/l]:[180,s[1]],o=o===a?n:a,o.push(h)}else o.push(s);t=r}return[a,n]},fixDateLineCoords:function(e){var t=0,r=[],a=[],n=[];current=r;for(var o=0;o<e.length;o++){var i=[e[o][0],e[o][1]];r.push([i[0]+t,i[1]]),a.push([i[0]+t-360,i[1]]),n.push([i[0]+t+360,i[1]]);var s=o+1;s==e.length&&(s=0);var p=[e[s][0],e[s][1]];i[0]-p[0]>180?t+=360:i[0]-p[0]<-180&&(t-=360)}return[r,a,n]},tesselateGreatCircleCoordinates:function(e){for(var t=[],r=0;r<e.length-1;r++)t.push(e[r]),this.tesselateGreatCircleLine(e[r],e[r+1],t);return t.push(e[e.length-1]),t},tesselateGreatCircleLine:function(e,t,r){var a=e[1],n=e[0],o=t[1],i=t[0];a*=Math.PI/180,n*=Math.PI/180,o*=Math.PI/180,i*=Math.PI/180;for(var s=2*Math.asin(Math.sqrt(Math.pow(Math.sin((a-o)/2),2)+Math.cos(a)*Math.cos(o)*Math.pow(Math.sin((n-i)/2),2))),p=Math.floor(6371*s/200),c=0,u=0;p-1>u;u++){c+=1/p;var l=Math.sin((1-c)*s)/Math.sin(s),d=Math.sin(c*s)/Math.sin(s),h=l*Math.cos(a)*Math.cos(n)+d*Math.cos(o)*Math.cos(i),m=l*Math.cos(a)*Math.sin(n)+d*Math.cos(o)*Math.sin(i),g=l*Math.sin(a)+d*Math.sin(o),f=Math.atan2(g,Math.sqrt(Math.pow(h,2)+Math.pow(m,2))),y=Math.atan2(m,h),v=f*(180/Math.PI),b=y*(180/Math.PI);r.push([b,v])}},parseUrl:function(e){var t={},r=e.split(/\?|\&/);return t.BASEURL=r[0],_.each(r,function(e){var r=e.split("=");2==r.length&&(t[r[0].toUpperCase()]=r[1])}),t},getLayerName:function(e){var t=this.parseUrl(e);if(!t.SERVICE)return console.warn("Url "+e+" hasn't got a SERVICE parameter"),null;var r="WMS"==t.SERVICE.toUpperCase()?"LAYERS":"LAYER";return t[r]},createWmsLayerFromUrl:function(e){var t=this.parseUrl(e),r="WMS"==t.SERVICE.toUpperCase()?"LAYERS":"LAYER",a={type:t.SERVICE,baseUrl:t.BASEURL,name:t[r],title:t[r],params:{format:t.FORMAT?decodeURIComponent(t.FORMAT):"image/png",style:t.STYLE,time:t.TIME?decodeURIComponent(t.TIME):null}};return"WMTS"==t.SERVICE.toUpperCase()?(a.params.matrixSet=t.TILEMATRIXSET,a.params.layer=t[r]):a.params.layers=t[r],a},toVector:function(e){var t=n(e.lat),r=n(e.lon),o=Math.cos(t)*Math.cos(r),i=Math.cos(t)*Math.sin(r),s=Math.sin(t);return new a(o,i,s)},greatCircle:function(e,t,r){var o=n(e),i=n(t),s=n(Number(r)),p=Math.sin(i)*Math.cos(s)-Math.sin(o)*Math.cos(i)*Math.sin(s),c=-Math.cos(i)*Math.cos(s)-Math.sin(o)*Math.sin(i)*Math.sin(s),u=Math.cos(o)*Math.sin(s);return new a(p,c,u)},distanceBetween:function(e,t,r){r=void 0===r?this.earthRadius:Number(r);var a=this.toVector(e),n=this.toVector(t),o=a.angleTo(n),i=o*r;return i},crossTrackDistanceBetween:function(e,t,r,a){a=void 0===a?this.earthRadius:Number(a);var n=this.toVector(e),o=this.toVector(t),i=this.toVector(r),s=o.cross(i),p=s.angleTo(n,n.cross(s));p=0>p?-Math.PI/2-p:Math.PI/2-p;var c=p*a;return c},distanceToSegment:function(e,t,r,a){var n=this.toVector(e),o=this.toVector(t),i=this.toVector(r),s=n.minus(o),p=i.minus(o),c=n.minus(i),u=o.minus(i),l=s.dot(p),d=c.dot(u),h=l>=0&&d>=0;if(h)var m=Math.abs(this.crossTrackDistanceBetween(e,t,r,a));else var g=this.distanceBetween(e,t,a),f=this.distanceBetween(e,r,a),m=Math.min(g,f);return m}}}),require.register("map/vector3d",function(e,t,r){"use strict";function a(e,t,r){return this instanceof a?(this.x=Number(e),this.y=Number(t),void(this.z=Number(r))):new a(e,t,r)}a.prototype.plus=function(e){if(!(e instanceof a))throw new TypeError("v is not Vector3d object");return new a(this.x+e.x,this.y+e.y,this.z+e.z)},a.prototype.minus=function(e){if(!(e instanceof a))throw new TypeError("v is not Vector3d object");return new a(this.x-e.x,this.y-e.y,this.z-e.z)},a.prototype.times=function(e){return e=Number(e),new a(this.x*e,this.y*e,this.z*e)},a.prototype.dividedBy=function(e){return e=Number(e),new a(this.x/e,this.y/e,this.z/e)},a.prototype.dot=function(e){if(!(e instanceof a))throw new TypeError("v is not Vector3d object");return this.x*e.x+this.y*e.y+this.z*e.z},a.prototype.cross=function(e){if(!(e instanceof a))throw new TypeError("v is not Vector3d object");var t=this.y*e.z-this.z*e.y,r=this.z*e.x-this.x*e.z,n=this.x*e.y-this.y*e.x;return new a(t,r,n)},a.prototype.negate=function(){return new a(-this.x,-this.y,-this.z)},a.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},a.prototype.unit=function(){var e=this.length();if(1==e)return this;if(0==e)return this;var t=this.x/e,r=this.y/e,n=this.z/e;return new a(t,r,n)},a.prototype.angleTo=function(e,t){if(!(e instanceof a))throw new TypeError("v is not Vector3d object");var r=this.cross(e).length(),n=this.dot(e);if(void 0!==t){if(!(t instanceof a))throw new TypeError("vSign is not Vector3d object");r=this.cross(e).dot(t)<0?-r:r}return Math.atan2(r,n)},a.prototype.rotateAround=function(e,t){if(!(e instanceof a))throw new TypeError("axis is not Vector3d object");for(var r=this.unit(),n=[r.x,r.y,r.z],o=e.unit(),i=Math.sin(t),s=Math.cos(t),p=[[o.x*o.x*(1-s)+s,o.x*o.y*(1-s)-o.z*i,o.x*o.z*(1-s)+o.y*i],[o.y*o.x*(1-s)+o.z*i,o.y*o.y*(1-s)+s,o.y*o.z*(1-s)-o.x*i],[o.z*o.x*(1-s)-o.y*i,o.z*o.y*(1-s)+o.x*i,o.z*o.z*(1-s)+s]],c=[0,0,0],u=0;3>u;u++)for(var l=0;3>l;l++)c[u]+=p[u][l]*n[l];var d=new a(c[0],c[1],c[2]);return d},a.prototype.toString=function(e){var t=void 0===e?3:Number(e),r="["+this.x.toFixed(t)+","+this.y.toFixed(t)+","+this.z.toFixed(t)+"]";return r},r.exports=a}),require.register("map/widget/background",function(e,t,r){var a,n=t("map/map"),o=(t("ui/widget"),function(){var e=$(this).closest("fieldset").find('input[name="background-choice"]:checked').data("layer");n.setBackgroundLayer(e),a.ngeowidget("hide")}),i=function(e){e.append('<div id="backgroundWidget"/>'),this.container=$('<fieldset data-role="controlgroup"></fieldset>');for(var t=n.backgroundLayers,r=0;r<t.length;r++)this.buildHtml(t[r]);a=$("#backgroundWidget").append(this.container).ngeowidget({activator:"#background"});var o=this;n.on("backgroundLayerAdded",function(e){o.buildHtml(e),$(backgroundWidget).trigger("create")}),n.on("backgroundLayerRemoved",function(e){o.container.find("input").each(function(){$(this).data("layer")==e&&$(this).parent().remove()}),$(backgroundWidget).trigger("create")}),n.on("backgroundLayerSelected",function(e){var t=_.find(o.container.find("input"),function(t){return $(t).data("layer")==e});$(t).prop("checked",!0).checkboxradio("refresh")});var i="#"+n.getBackgroundLayer().id;$(e).find(i).prop("checked","checked").checkboxradio("refresh")};i.prototype.buildHtml=function(e){var t=e.visible?'checked="checked"':"",r=e.id?e.id:e.name.replace(/\s+/g,"_"),a=$('<input id="'+r+'" type="radio" name="background-choice" '+t+" />").data("layer",e).change(o);$('<label for="'+r+'" data-mini="true">'+e.name+"</label>").append(a).appendTo(this.container)},r.exports=i}),require.register("map/widget/layers",function(e,t,r){var a=t("map/map"),n=(t("ui/widget"),t("map/selectHandler")),o=function(){var e=$(this).data("layer"),t=!e.params.visible;e.setVisible(t)},i=function(e){var t=$('<div id="layersWidget"/>').appendTo(e);this.container=$("<fieldset data-role='controlgroup'></fieldset>");var r=a.layers;a.on("visibility:changed",function(e){var t=null;i.container.find("input").each(function(){return $(this).data("layer")==e?void(t=$(this)):void 0});var r=e.params.visible;t&&(r?t.prop("checked","checked").checkboxradio("refresh"):t.removeProp("checked").checkboxradio("refresh")),n.setPickable(e,r)});for(var o=0;o<r.length;o++)this.buildHTML(r[o]);this.container.appendTo(t);var i=this;a.on("layerAdded",function(e){"Browses"!=e.params.type&&-1==e.params.name.indexOf("Footprints")&&(i.buildHTML(e),t.trigger("create"))}),a.on("layerRemoved",function(e){"Browses"!=e.type&&-1==e.params.name.indexOf("Footprints")&&(i.container.find("input").each(function(){$(this).data("layer")==e&&$(this).parent().remove()}),t.trigger("create"))}),this.$el=t};i.prototype.buildHTML=function(e){if(-1==e.params.name.indexOf("Footprints")){var t=$("<input type='checkbox'"+(e.params.visible?"checked='checked'":"")+">").data("layer",e);t.change(o),$("<label data-mini='true'>"+(e.params.title?e.params.title:e.params.name)+"</label>").prepend(t).appendTo(this.container)}},i.prototype.refresh=function(){this.container.empty();for(var e=a.layers,t=0;t<e.length;t++)this.buildHTML(e[t]);this.$el.trigger("create")},r.exports=i}),require.register("map/widget/mapPopup",function(e,t,r){var a=t("globalEvents"),n=t("logger"),o=t("configuration"),i=t("map/map"),s=(t("search/model/downloadOptions"),t("dataAccess/model/simpleDataAccessRequest")),p=t("dataAccess/widget/dataAccessWidget"),c=t("searchResults/model/searchResults"),u=(t("map/utils"),t("userPrefs"),t("searchResults/widget/multipleBrowseWidget")),l=t("ui/productService"),d=function(e){var t,r,d=this,h=null,m=!1;t=$('<div class="mapPopup">			<div id="mpText"></div>			<div id="mpButtons"></div>		</div>'),t.wrap("<div id='mapPopup'></div>"),r=t.parent(),btn=$("<a class='check' title='Pin/Unpin products'><span></span></a>").appendTo(t.find("#mpButtons")).click(function(){var e=$(this).hasClass("select");e?$(this).removeClass("select"):$(this).addClass("select");for(var t=h,r=0;r<t.length;r++){var a=t[r];e?a._featureCollection.unselect([a]):a._featureCollection.select([a])}d.openOrCloseDialog()}),btn=$("<a class='browse-multiple' title='Multiple browse management'><span></span></a>").appendTo(t.find("#mpButtons")).click(function(e){var t=$(this).hasClass("active");t&&u.open({feature:h[0],featureCollection:h[0]._featureCollection})}),btn=$("<a class='download' title='Direct download product'><span></span></a>").appendTo(t.find("#mpButtons")).click(function(e){var t=$(this).hasClass("active");if(t){var r=o.getMappedProperty(h[0],"productUrl",null);window.open(r)}}),btn=$("<a class='save' title='Retrieve product'><span></span></a>").appendTo(t.find("#mpButtons")).click(function(){var e=$(this).hasClass("active");if(e){for(var t=[],r=0;r<h.length;r++)h[r]._featureCollection.downloadAccess&&t.push(h[r]);t.length>0?(s.initialize(),s.setProducts(t),p.open(s)):n.inform("Cannot download product : missing permissions.")}}),btn=$("<a class='shop' title='Add to shopcart'><span></span></a>").appendTo(t.find("#mpButtons")).click(function(){var e=$(this).hasClass("active");e&&a.trigger("addToShopcart",h)}),r.appendTo(e),r.trigger("create"),r.hide(),i.on("highlightFeatures",function(e){d.openOrCloseDialog("highlight",e)}),i.on("unhighlightFeatures",function(e){d.openOrCloseDialog("highlight",e)}),i.on("unselectFeatures",function(){d.openOrCloseDialog("select",[])}),i.on("selectFeatures",function(e){d.openOrCloseDialog("select",e)});var g=function(e){t.find("#mpButtons a.check").addClass("active"),t.find("#mpButtons a.save").hide(),t.find("#mpButtons a.shop").hide(),o.data.behindSSO&&(t.find("#mpButtons a.shop").show(),o.data.downloadManager.enable&&t.find("#mpButtons a.save").show()),t.find("#mpButtons a.download").removeClass("active");var r="";if(e>1&&(r+=""+e+" products picked.<br><span class='clickagain'>(Click again on same location to pick one product at a time)</span>.<br>",t.find("#mpButtons a.browse-multiple").removeClass("active")),1===e){var a=h[0],n="",i=o.getMappedProperty(a,"sensor","-");n+=i+" / ",i=o.getMappedProperty(a,"operationalMode","-"),n+=i+" / ",i=o.getMappedProperty(a,"productType","-"),n+=i,r+="<p><b>"+n+"</b></p>";for(var s=o.data.tableView.columnsDef,p=0;p<s.length;p++)if("Product URL"!=s[p].sTitle){var c=o.getPropertyFromPaths(a,s[p].mData);if("Download options"==s[p].sTitle&&c)continue;c&&(r+="<p>"+s[p].sTitle+': <span title="'+c+'">'+c+"</span></p>")}var u=o.getMappedProperty(a,"browses");if(u&&u.length>1){var l=!1;_.each(u,function(e){var t=e.BrowseInformation.fileName.ServiceReference["@"].href;t.indexOf("SERVICE")>-1&&(l=!0)}),l?t.find("#mpButtons a.browse-multiple").addClass("active"):t.find("#mpButtons a.browse-multiple").removeClass("active")}else t.find("#mpButtons a.browse-multiple").removeClass("active");var d=o.getMappedProperty(a,"productUrl",null);null!==d&&t.find("#mpButtons a.download").addClass("active"),a._featureCollection.isSelected(a)?t.find("#mpButtons a.check").addClass("select"):t.find("#mpButtons a.check").removeClass("select"),"undefined"==typeof a.properties.shopcart_id?t.find("#mpButtons a.shop").addClass("active"):t.find("#mpButtons a.shop").removeClass("active")}else{r+="<p>Products: </p>";for(var m=!0,g=!0,p=0;p<h.length;p++){var f=h[p];r+="<p class='oneproduct' title='"+f.id+"'>";var y=o.getMappedProperty(f,"productType",null);if(null!==y)r+=y+" / ";else{var v=o.getMappedProperty(f,"sensor",null);null!==v&&(r+=v+" / ")}r+=o.getMappedProperty(f,"start"),r+="</p>";var b=f._featureCollection.isSelected(f);b||(m=!1),"undefined"==typeof f.properties.shopcart_id&&(g=!1)}m?t.find("#mpButtons a.check").addClass("select"):t.find("#mpButtons a.check").removeClass("select"),g?t.find("#mpButtons a.shop").removeClass("active"):t.find("#mpButtons a.shop").addClass("active")}var L=_.find(h,function(e){return e._featureCollection.isHighlighted(e)});L?t.find("#mpButtons a.save").addClass("active"):t.find("#mpButtons a.save").removeClass("active");var M=_.find(h,function(e){return"PLANNED"==o.getMappedProperty(e,"status",null)||!o.getMappedProperty(e,"productUrl")});M&&t.find("#mpButtons a.save").removeClass("active"),t.find("#mpText").html(r)};this.open=function(e){h=e,g(h.length),r.fadeIn(),m=!0},this.close=function(){m&&(r.stop(!0).fadeOut(),m=!1)},this.openOrCloseDialog=function(e,t){t=l.getHighlightedProducts(),t&&0!=t.length?this.open(t):this.close()},c.on("reset:features",this.close,this)};r.exports=d}),require.register("map/widget/toolbarMap",function(e,t,r){var a=t("map/map"),n=t("map/widget/layers"),o=t("map/widget/background"),i=t("userPrefs"),s=i.get("Map mode")?"2d"==i.get("Map mode"):!0;r.exports=function(e){this.layersWidget=new n(e),this.layersWidget.$el.ngeowidget({activator:"#layers"}),new o(e),$("#zoomIn").click(function(){a.zoomIn()}),$("#zoomOut").click(function(){a.zoomOut()}),$("#home").click(function(){a.zoomToMaxExtent()}),$("#switch").click(function(){s=!s,a.switchMapEngine(s?"2d":"3d")||($('<div><p>3D map is not available because WebGL is not supported by your browser, see <a href="http://get.webgl.org/">here</a> for more details.</p></div>').appendTo("#mapContainer").popup().popup("open"),s=!0,a.switchMapEngine("2d"))})}});
//# sourceMappingURL=map.js.map